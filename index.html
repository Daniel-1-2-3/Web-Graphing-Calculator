<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div class="calculator">
        <div id="display">
            <div id="text-before-caret" class="displayText"></div>
            <span id="caret"></span>
            <div id="text-after-caret" class="displayText"></div>
        </div>
        <div>
            <button onclick="clearDisplay()">C</button>
            <button onclick="addElement('(')">(</button>
            <button onclick="addElement(')')">)</button>
            <button class="operation" onclick="addElement('/')">/</button>
        </div>
        <div>
            <button onclick="addElement('7')">7</button>
            <button onclick="addElement('8')">8</button>
            <button onclick="addElement('9')">9</button>
            <button class="operation" onclick="addElement('*')">*</button>
        </div>
        <div>
            <button onclick="addElement('4')">4</button>
            <button onclick="addElement('5')">5</button>
            <button onclick="addElement('6')">6</button>
            <button class="operation" onclick="addElement('-')">-</button>
        </div>
        <div>
            <button onclick="addElement('1')">1</button>
            <button onclick="addElement('2')">2</button>
            <button onclick="addElement('3')">3</button>
            <button class="operation" onclick="addElement('+')">+</button>
        </div>
        <div>
            <button onclick="addElement('0')">0</button>
            <button onclick="addElement('.')">.</button>
            <button class="equals" onclick="calculateResult()">=</button>
        </div>
    </div>

    <script>
    let caretPosition = 0
    let displayText = ''
        function getCaretPxPos() {
            return document.getElementById('text-before-caret').offsetWidth;
        }

        function addElement(value) {
            prevCaretPos =  getCaretPxPos();
            displayText = displayText.slice(0, caretPosition) + value + displayText.slice(caretPosition);
            caretPosition += value.length;
            renderDisplay();
            currentCaretPos = getCaretPxPos()
            document.getElementById('display').scrollLeft += currentCaretPos - prevCaretPos; 
        }

        function renderDisplay() {
            // Update text-before and text-after caret
            document.getElementById('text-before-caret').textContent = displayText.slice(0, caretPosition).replace(/\s+/g, '');;
            document.getElementById('text-after-caret').textContent = displayText.slice(caretPosition).replace(/\s+/g, '');;
            document.activeElement.blur();
        }

        function clearDisplay() {
            displayText = '';
            caretPosition = 0;
            renderDisplay();
            document.activeElement.blur();
        }

        function calculateResult() {
            try {
                displayText = eval(displayText).toString();
                displayText = (displayText === 'Infinity') ? displayText = 'Error' : displayText;
                document.getElementById('display').scrollLeft = document.getElementById('display').scrollWidth;

            } catch (error) {
                displayText = 'Error';
            } finally {
                caretPosition = displayText.length;
                renderDisplay();
            }   
            document.activeElement.blur();
        }

        document.addEventListener('keydown', function(event) {
            const key = event.key;

            if (!isNaN(key) || ['+', '*', '/', '-', '(', ')', '.'].includes(key)){
                addElement(key);
            }
            else if (key==='Backspace'){
                if (caretPosition != 0){
                    displayText = displayText.slice(0, caretPosition - 1) + displayText.slice(caretPosition);
                };
                caretPosition = Math.max(0, caretPosition - 1);
                renderDisplay();
            } else if (key==='Enter' || key==='='){
                calculateResult();
            } else if (key==='ArrowRight'){
                prevCaretPos = getCaretPxPos();
                caretPosition = Math.min(displayText.length, caretPosition + 1);
                renderDisplay();
                currentCaretPos = getCaretPxPos();
                document.getElementById('display').scrollLeft += (currentCaretPos - prevCaretPos);
            } else if (key==='ArrowLeft'){
                prevCaretPos = getCaretPxPos();
                caretPosition = Math.max(0, caretPosition - 1);
                renderDisplay();
                currentCaretPos = getCaretPxPos();
                document.getElementById('display').scrollLeft += (currentCaretPos - prevCaretPos);
            }
            document.activeElement.blur();
        });
    </script>

</body>
</html>
